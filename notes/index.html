<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notes</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23fe8019'/><text x='50' y='50' text-anchor='middle' dy='.35em' font-size='60' fill='%23ffffff' font-family='Arial,sans-serif' font-weight='bold'>N</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; height: 100vh; display: flex; flex-direction: column; transition: background-color 0.2s, color 0.2s; }
        body.dark { background: #282828; color: #d4be98; }
        body.light { background: #fbf1c7; color: #654735; }
        .toolbar { padding: 8px 12px; display: flex; gap: 12px; align-items: center; transition: background-color 0.2s, border-color 0.2s; flex-wrap: wrap; }
        body.dark .toolbar { background: #32302f; border-bottom: 1px solid #504945; }
        body.light .toolbar { background: #f2e5bc; border-bottom: 1px solid #d5c4a1; }
        .tabs { display: flex; gap: 4px; flex: 1; overflow-x: auto; min-width: 200px; }
        .tab { padding: 6px 12px; cursor: pointer; border-radius: 4px 4px 0 0; white-space: nowrap; display: flex; align-items: center; gap: 8px; transition: background-color 0.2s, border-color 0.2s; }
        body.dark .tab { background: #3c3836; border: 1px solid #504945; }
        body.light .tab { background: #ebdbb2; border: 1px solid #d5c4a1; }
        body.dark .tab.active { background: #282828; border-bottom-color: #282828; }
        body.light .tab.active { background: #fbf1c7; border-bottom-color: #fbf1c7; }
        .tab-name { flex: 1; }
        .tab-name input { background: transparent; border: none; outline: none; font-size: 14px; width: 100%; padding: 0; }
        body.dark .tab-name input { color: #d4be98; }
        body.light .tab-name input { color: #654735; }
        .tab-close { cursor: pointer; font-weight: bold; }
        body.dark .tab-close { color: #a89984; }
        body.light .tab-close { color: #928374; }
        body.dark .tab-close:hover { color: #d4be98; }
        body.light .tab-close:hover { color: #654735; }
        button { border: none; color: #282828; padding: 6px 12px; cursor: pointer; border-radius: 4px; font-size: 16px; transition: background-color 0.2s; font-weight: 500; line-height: 1; }
        body.dark button { background: #a9b665; color: #282828; }
        body.dark button:hover { background: #b8bb26; }
        body.light button { background: #98971a; color: #fbf1c7; }
        body.light button:hover { background: #79740e; }
        body.dark button.active { background: #7daea3; }
        body.light button.active { background: #427b58; color: #fbf1c7; }
        button.sync-btn { background: #689d6a; color: #fbf1c7; }
        button.sync-btn:hover { background: #8ec07c; }
        select { border: 1px solid; padding: 6px; border-radius: 4px; cursor: pointer; transition: background-color 0.2s, color 0.2s, border-color 0.2s; font-size: 14px; }
        body.dark select { background: #3c3836; color: #d4be98; border-color: #504945; }
        body.light select { background: #ebdbb2; color: #654735; border-color: #d5c4a1; }
        .controls { display: flex; gap: 8px; align-items: center; }
        label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-size: 14px; }
        input[type="checkbox"] { cursor: pointer; }
        .editor-container { flex: 1; position: relative; overflow: hidden; }
        .editor-wrapper { width: 100%; height: 100%; display: flex; justify-content: center; }
        .editor-wrapper.centered { padding: 0 10%; }
        body.dark .editor-wrapper.centered { background: linear-gradient(to right, transparent 0%, transparent 10%, rgba(80, 73, 69, 0.3) 10%, rgba(80, 73, 69, 0.3) 10.1%, transparent 10.1%), linear-gradient(to left, transparent 0%, transparent 10%, rgba(80, 73, 69, 0.3) 10%, rgba(80, 73, 69, 0.3) 10.1%, transparent 10.1%); }
        body.light .editor-wrapper.centered { background: linear-gradient(to right, transparent 0%, transparent 10%, rgba(213, 196, 161, 0.3) 10%, rgba(213, 196, 161, 0.3) 10.1%, transparent 10.1%), linear-gradient(to left, transparent 0%, transparent 10%, rgba(213, 196, 161, 0.3) 10%, rgba(213, 196, 161, 0.3) 10.1%, transparent 10.1%); }
        textarea { width: 100%; height: 100%; border: none; padding: 16px; resize: none; outline: none; font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; transition: background-color 0.2s, color 0.2s; line-height: 1.5; }
        body.dark textarea { background: transparent; color: #d4be98; }
        body.light textarea { background: transparent; color: #654735; }
        body.dark textarea::placeholder { color: #665c54; }
        body.light textarea::placeholder { color: #bdae93; }
        body.dark textarea::selection { background: #504945; }
        body.light textarea::selection { background: #d5c4a1; }
        textarea.mono { font-family: 'JetBrains Mono', 'Courier New', Consolas, monospace; }
        .preview { width: 100%; height: 100%; padding: 16px; overflow-y: auto; display: none; }
        body.dark .preview { background: #282828; color: #d4be98; }
        body.light .preview { background: #fbf1c7; color: #654735; }
        .preview.active { display: block; }
        .preview h1, .preview h2, .preview h3, .preview h4, .preview h5, .preview h6 { margin-top: 24px; margin-bottom: 16px; font-weight: 600; line-height: 1.25; }
        body.dark .preview h1, body.dark .preview h2, body.dark .preview h3 { color: #e78a4e; }
        body.light .preview h1, body.light .preview h2, body.light .preview h3 { color: #af3a03; }
        body.dark .preview h1 { font-size: 2em; border-bottom: 1px solid #504945; padding-bottom: 8px; }
        body.dark .preview h2 { font-size: 1.5em; border-bottom: 1px solid #504945; padding-bottom: 8px; }
        body.light .preview h1 { font-size: 2em; border-bottom: 1px solid #d5c4a1; padding-bottom: 8px; }
        body.light .preview h2 { font-size: 1.5em; border-bottom: 1px solid #d5c4a1; padding-bottom: 8px; }
        .preview h3 { font-size: 1.25em; }
        .preview h4 { font-size: 1em; }
        .preview p { margin-bottom: 16px; line-height: 1.6; }
        .preview ul, .preview ol { margin-bottom: 16px; padding-left: 32px; }
        .preview li { margin-bottom: 8px; line-height: 1.6; }
        .preview code { padding: 2px 6px; border-radius: 3px; font-family: 'JetBrains Mono', 'Courier New', Consolas, monospace; font-size: 0.9em; }
        body.dark .preview code { background: #3c3836; color: #d8a657; }
        body.light .preview code { background: #ebdbb2; color: #b57614; }
        .preview pre { padding: 16px; border-radius: 6px; overflow-x: auto; margin-bottom: 16px; }
        body.dark .preview pre { background: #3c3836; }
        body.light .preview pre { background: #ebdbb2; }
        .preview pre code { padding: 0; background: transparent; }
        .preview blockquote { margin: 0 0 16px 0; padding-left: 16px; }
        body.dark .preview blockquote { border-left: 4px solid #7daea3; color: #a89984; }
        body.light .preview blockquote { border-left: 4px solid #427b58; color: #928374; }
        .preview a { text-decoration: none; }
        body.dark .preview a { color: #7daea3; }
        body.light .preview a { color: #076678; }
        .preview a:hover { text-decoration: underline; }
        .preview table { border-collapse: collapse; margin-bottom: 16px; width: 100%; }
        .preview table th, .preview table td { padding: 8px 12px; }
        body.dark .preview table th, body.dark .preview table td { border: 1px solid #504945; }
        body.light .preview table th, body.light .preview table td { border: 1px solid #d5c4a1; }
        body.dark .preview table th { background: #3c3836; }
        body.light .preview table th { background: #ebdbb2; }
        .preview img { max-width: 100%; height: auto; }
        .preview hr { border: none; margin: 24px 0; }
        body.dark .preview hr { border-top: 1px solid #504945; }
        body.light .preview hr { border-top: 1px solid #d5c4a1; }
        .preview strong { font-weight: 600; }
        body.dark .preview strong { color: #e78a4e; }
        body.light .preview strong { color: #af3a03; }
        .preview em { font-style: italic; }
        .stats { padding: 4px 12px; font-size: 12px; transition: background-color 0.2s, color 0.2s, border-color 0.2s; display: flex; gap: 16px; align-items: center; }
        body.dark .stats { background: #32302f; color: #a89984; border-top: 1px solid #504945; }
        body.light .stats { background: #f2e5bc; color: #928374; border-top: 1px solid #d5c4a1; }
        .save-indicator { opacity: 0; transition: opacity 0.3s; }
        .save-indicator.show { opacity: 1; }
        body.dark .save-indicator { color: #a9b665; }
        body.light .save-indicator { color: #98971a; }
        .sync-status { font-size: 11px; }
        .sync-status.synced { color: #a9b665; }
        .sync-status.error { color: #fb4934; }
        .search-panel { padding: 8px 12px; display: none; gap: 8px; align-items: center; transition: background-color 0.2s, border-color 0.2s; flex-wrap: wrap; }
        .search-panel.active { display: flex; }
        body.dark .search-panel { background: #32302f; border-bottom: 1px solid #504945; }
        body.light .search-panel { background: #f2e5bc; border-bottom: 1px solid #d5c4a1; }
        .search-input { flex: 1; min-width: 150px; padding: 6px 12px; border: 1px solid; border-radius: 4px; font-size: 14px; }
        body.dark .search-input { background: #3c3836; color: #d4be98; border-color: #504945; }
        body.light .search-input { background: #ebdbb2; color: #654735; border-color: #d5c4a1; }
        .search-results { font-size: 12px; }
        body.dark .search-results { color: #a89984; }
        body.light .search-results { color: #928374; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 1000; justify-content: center; align-items: center; }
        .modal.active { display: flex; }
        .modal-content { max-width: 600px; max-height: 80vh; overflow-y: auto; padding: 24px; border-radius: 8px; margin: 20px; }
        body.dark .modal-content { background: #282828; border: 1px solid #504945; }
        body.light .modal-content { background: #fbf1c7; border: 1px solid #d5c4a1; }
        .modal-content h2 { margin-bottom: 16px; }
        body.dark .modal-content h2 { color: #e78a4e; }
        body.light .modal-content h2 { color: #af3a03; }
        .modal-content h3 { margin-top: 20px; margin-bottom: 12px; font-size: 1.1em; }
        body.dark .modal-content h3 { color: #d8a657; }
        body.light .modal-content h3 { color: #b57614; }
        .modal-content table { width: 100%; border-collapse: collapse; margin-bottom: 16px; }
        .modal-content th, .modal-content td { padding: 8px 12px; text-align: left; }
        body.dark .modal-content th, body.dark .modal-content td { border: 1px solid #504945; }
        body.light .modal-content th, body.light .modal-content td { border: 1px solid #d5c4a1; }
        body.dark .modal-content th { background: #3c3836; }
        body.light .modal-content th { background: #ebdbb2; }
        .modal-content code { padding: 2px 6px; border-radius: 3px; font-family: 'JetBrains Mono', monospace; font-size: 0.9em; }
        body.dark .modal-content code { background: #3c3836; color: #d8a657; }
        body.light .modal-content code { background: #ebdbb2; color: #b57614; }
        .modal-content p { margin-bottom: 12px; line-height: 1.6; }
        .modal-content ol { margin-left: 20px; line-height: 1.8; }
        .modal-content input { width: 100%; padding: 10px; border: 1px solid; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 13px; margin-top: 8px; }
        body.dark .modal-content input { background: #3c3836; color: #d4be98; border-color: #504945; }
        body.light .modal-content input { background: #ebdbb2; color: #654735; border-color: #d5c4a1; }
        .help-close { margin-top: 20px; }
        .theme-toggle { background: transparent; font-size: 18px; padding: 4px 8px; }
        body.dark .theme-toggle { color: #d4be98; }
        body.light .theme-toggle { color: #654735; }
        body.dark .theme-toggle:hover { background: #3c3836; }
        body.light .theme-toggle:hover { background: #ebdbb2; }
    </style>
</head>
<body class="dark">
    <div class="toolbar">
        <div class="tabs" id="tabs"></div>
        <button onclick="addTab()" title="New Tab">➕</button>
        <button id="previewBtn" onclick="togglePreview()" title="Toggle Preview (Cmd+E)">✏️</button>
        <button onclick="toggleSearch()" title="Search & Replace (Cmd+Shift+F)">🔍</button>
        <div class="controls">
            <select id="fontSelect" onchange="changeFont()">
                <option value="normal">Normal</option>
                <option value="mono">Mono</option>
            </select>
            <select id="fontSizeSelect" onchange="changeFontSize()">
                <option value="14">14px</option>
                <option value="15">15px</option>
                <option value="16">16px</option>
                <option value="17">17px</option>
                <option value="18">18px</option>
            </select>
            <label title="Center text with 10% margins">
                <input type="checkbox" id="centerCheckbox" onchange="toggleCenter()" checked>
                <span>Center</span>
            </label>
        </div>
        <button class="sync-btn" id="syncSetupBtn" onclick="showSyncSetup()" title="Setup GitHub Sync">☁️ Setup</button>
        <button class="sync-btn" id="syncNowBtn" onclick="syncNow()" style="display:none;" title="Sync Now">↻ Sync</button>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">◐</button>
        <button onclick="toggleHelp()" title="Keyboard Shortcuts">?</button>
    </div>
    <div class="search-panel" id="searchPanel">
        <input type="text" class="search-input" id="searchInput" placeholder="Find..." style="flex: 0 0 200px;">
        <input type="text" class="search-input" id="replaceInput" placeholder="Replace..." style="flex: 0 0 200px;">
        <button onclick="replaceNext()">Replace</button>
        <button onclick="replaceAll()">Replace All</button>
        <span class="search-results" id="searchResults"></span>
        <button onclick="toggleSearch()">Close</button>
    </div>
    <div class="editor-container">
        <div id="editorWrapper" class="editor-wrapper centered">
            <textarea id="editor" placeholder="Start typing..."></textarea>
            <div id="preview" class="preview"></div>
        </div>
    </div>
    <div class="stats">
        <span id="charCount">0 characters</span>
        <span id="wordCount">0 words</span>
        <span id="lineCount">0 lines</span>
        <span class="save-indicator" id="saveIndicator">💾 Saved</span>
        <span class="sync-status" id="syncStatus"></span>
    </div>

    <div class="modal" id="syncModal" onclick="if(event.target === this) closeSyncModal()">
        <div class="modal-content">
            <h2>Setup GitHub Sync</h2>
            <p>Sync your notes across devices using GitHub Gists (private storage).</p>
            <h3>Setup Steps:</h3>
            <ol>
                <li>Go to <a href="https://github.com/settings/tokens" target="_blank" style="color: #7daea3;">github.com/settings/tokens</a></li>
                <li>Click "Generate new token" → "Generate new token (classic)"</li>
                <li>Name it "Notes Sync"</li>
                <li>Check ONLY the <code>gist</code> scope</li>
                <li>Click "Generate token"</li>
                <li>Copy token and paste below</li>
            </ol>
            <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
            <p style="font-size: 12px; margin-top: 8px; color: #928374;">Token stored locally. Auto-syncs every 2 minutes.</p>
            <button onclick="setupSync()" style="margin-top: 16px;">Enable Sync</button>
            <button onclick="closeSyncModal()" style="margin-left: 8px;">Cancel</button>
            <div style="margin-top: 20px; padding: 12px; background: #3c3836; border-radius: 4px; font-size: 12px;">
                <strong>Already configured?</strong><br>
                <button onclick="disableSync()" class="sync-btn" style="margin-top: 8px; padding: 4px 10px; font-size: 12px; background: #cc241d;">Disable Sync</button>
            </div>
        </div>
    </div>

    <div class="modal" id="helpModal" onclick="if(event.target === this) toggleHelp()">
        <div class="modal-content">
            <h2>Keyboard Shortcuts</h2>
            <h3>Markdown Formatting</h3>
            <table>
                <tr><th>Shortcut</th><th>Action</th></tr>
                <tr><td><code>Cmd+B</code></td><td>Bold (<code>**text**</code>)</td></tr>
                <tr><td><code>Cmd+I</code></td><td>Italic (<code>*text*</code>)</td></tr>
                <tr><td><code>Cmd+K</code></td><td>Link (<code>[text](url)</code>)</td></tr>
                <tr><td><code>Cmd+`</code></td><td>Inline code (<code>`text`</code>)</td></tr>
                <tr><td><code>Cmd+Shift+C</code></td><td>Code block (<code>```text```</code>)</td></tr>
            </table>
            <h3>Editor Controls</h3>
            <table>
                <tr><th>Shortcut</th><th>Action</th></tr>
                <tr><td><code>Cmd+E</code></td><td>Toggle Edit/Preview</td></tr>
                <tr><td><code>Cmd+Shift+F</code></td><td>Search & Replace</td></tr>
                <tr><td><code>Cmd+1-9</code></td><td>Switch to tab 1-9</td></tr>
            </table>
            <button class="help-close" onclick="toggleHelp()">Close</button>
        </div>
    </div>

    <script>
        const GITHUB_API = 'https://api.github.com';
        const LINE_LIMIT = 10000;
        const SAVE_DEBOUNCE_MS = 60000;
        const SYNC_INTERVAL_MS = 120000; // 2 minutes

        let tabs = JSON.parse(localStorage.getItem('notes_tabs')) || [{id: 1, name: 'Note 1', content: ''}];
        let currentTabId = parseInt(localStorage.getItem('notes_current_tab')) || 1;
        let nextTabId = Math.max(...tabs.map(t => t.id)) + 1;
        let isPreviewMode = false;
        let isCentered = localStorage.getItem('notes_centered') !== 'false';
        let saveTimeout = null;
        let searchMatches = [];
        let syncInterval = null;
        let lastSyncTime = 0;
        
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const editorWrapper = document.getElementById('editorWrapper');
        const previewBtn = document.getElementById('previewBtn');
        const fontSelect = document.getElementById('fontSelect');
        const fontSizeSelect = document.getElementById('fontSizeSelect');
        const centerCheckbox = document.getElementById('centerCheckbox');
        const saveIndicator = document.getElementById('saveIndicator');
        const searchPanel = document.getElementById('searchPanel');
        const searchInput = document.getElementById('searchInput');
        const replaceInput = document.getElementById('replaceInput');
        const searchResults = document.getElementById('searchResults');
        const helpModal = document.getElementById('helpModal');
        const syncModal = document.getElementById('syncModal');
        const syncStatus = document.getElementById('syncStatus');
        const syncSetupBtn = document.getElementById('syncSetupBtn');
        const syncNowBtn = document.getElementById('syncNowBtn');
        
        const savedFont = localStorage.getItem('notes_font') || 'normal';
        fontSelect.value = savedFont;
        if (savedFont === 'mono') editor.classList.add('mono');

        const savedFontSize = localStorage.getItem('notes_font_size') || (savedFont === 'mono' ? '15' : '16');
        fontSizeSelect.value = savedFontSize;
        editor.style.fontSize = savedFontSize + 'px';
        preview.style.fontSize = savedFontSize + 'px';

        const savedTheme = localStorage.getItem('notes_theme') || 'dark';
        document.body.className = savedTheme;

        centerCheckbox.checked = isCentered;
        if (isCentered) editorWrapper.classList.add('centered');

        function showSaveIndicator() {
            saveIndicator.classList.add('show');
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveIndicator.classList.remove('show'), 1500);
        }

        function renderTabs() {
            const tabsContainer = document.getElementById('tabs');
            tabsContainer.innerHTML = '';
            tabs.forEach(tab => {
                const tabEl = document.createElement('div');
                tabEl.className = 'tab' + (tab.id === currentTabId ? ' active' : '');
                tabEl.innerHTML = `<span class="tab-name" ondblclick="editTabName(${tab.id}, this)"><span>${escapeHtml(tab.name)}</span></span>${tabs.length > 1 ? `<span class="tab-close" onclick="closeTab(event, ${tab.id})">×</span>` : ''}`;
                tabEl.onclick = (e) => { if (!e.target.closest('.tab-close') && !e.target.closest('.tab-name')) switchTab(tab.id); };
                tabsContainer.appendChild(tabEl);
            });
        }

        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        function editTabName(tabId, element) {
            const tab = tabs.find(t => t.id === tabId);
            const span = element.querySelector('span');
            const currentName = span.textContent;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.style.width = Math.max(50, currentName.length * 8) + 'px';
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
            function finishEdit() { const newName = input.value.trim() || currentName; tab.name = newName; saveTabs(); renderTabs(); }
            input.addEventListener('blur', finishEdit);
            input.addEventListener('keydown', (e) => { if (e.key === 'Enter') finishEdit(); else if (e.key === 'Escape') renderTabs(); });
        }

        function switchTab(tabId) {
            const currentTab = tabs.find(t => t.id === currentTabId);
            if (currentTab) currentTab.content = editor.value;
            currentTabId = tabId;
            const newTab = tabs.find(t => t.id === tabId);
            editor.value = newTab.content;
            saveTabs();
            renderTabs();
            updateStats();
            if (isPreviewMode) updatePreview();
        }

        function addTab() {
            const newTab = { id: nextTabId++, name: `Note ${tabs.length + 1}`, content: '' };
            tabs.push(newTab);
            switchTab(newTab.id);
        }

        function closeTab(event, tabId) {
            event.stopPropagation();
            if (tabs.length === 1) return;
            const index = tabs.findIndex(t => t.id === tabId);
            tabs.splice(index, 1);
            if (currentTabId === tabId) {
                currentTabId = tabs[Math.max(0, index - 1)].id;
                editor.value = tabs.find(t => t.id === currentTabId).content;
            }
            saveTabs();
            renderTabs();
            updateStats();
            if (isPreviewMode) updatePreview();
        }

        function debouncedSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => saveTabs(), SAVE_DEBOUNCE_MS);
        }

        function saveTabs() {
            const currentTab = tabs.find(t => t.id === currentTabId);
            if (currentTab) currentTab.content = editor.value;
            localStorage.setItem('notes_tabs', JSON.stringify(tabs));
            localStorage.setItem('notes_current_tab', currentTabId);
            showSaveIndicator();
        }

        function changeFont() {
            const font = fontSelect.value;
            if (font === 'mono') {
                editor.classList.add('mono');
                if (fontSizeSelect.value === '16') { fontSizeSelect.value = '15'; changeFontSize(); }
            } else {
                editor.classList.remove('mono');
                if (fontSizeSelect.value === '15') { fontSizeSelect.value = '16'; changeFontSize(); }
            }
            localStorage.setItem('notes_font', font);
        }

        function changeFontSize() {
            const size = fontSizeSelect.value;
            editor.style.fontSize = size + 'px';
            preview.style.fontSize = size + 'px';
            localStorage.setItem('notes_font_size', size);
        }

        function toggleCenter() {
            isCentered = centerCheckbox.checked;
            if (isCentered) editorWrapper.classList.add('centered');
            else editorWrapper.classList.remove('centered');
            localStorage.setItem('notes_centered', isCentered);
        }

        function toggleTheme() {
            const currentTheme = document.body.className;
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.body.className = newTheme;
            localStorage.setItem('notes_theme', newTheme);
        }

        function togglePreview() {
            isPreviewMode = !isPreviewMode;
            if (isPreviewMode) {
                updatePreview();
                preview.classList.add('active');
                editor.style.display = 'none';
                previewBtn.textContent = '👁️';
                previewBtn.classList.add('active');
            } else {
                preview.classList.remove('active');
                editor.style.display = 'block';
                previewBtn.textContent = '✏️';
                previewBtn.classList.remove('active');
            }
        }

        function updatePreview() {
            if (typeof marked !== 'undefined') preview.innerHTML = marked.parse(editor.value, { breaks: true, gfm: true });
            else preview.textContent = 'Loading markdown parser...';
        }

        function updateStats() {
            const text = editor.value;
            const chars = text.length;
            const words = text.trim() ? text.trim().split(/\s+/).length : 0;
            const lines = text ? text.split('\n').length : 0;
            document.getElementById('charCount').textContent = `${chars} characters`;
            document.getElementById('wordCount').textContent = `${words} words`;
            document.getElementById('lineCount').textContent = `${lines} lines`;
        }

        function toggleSearch() {
            const isActive = searchPanel.classList.toggle('active');
            if (isActive) searchInput.focus();
            else { searchInput.value = ''; replaceInput.value = ''; searchResults.textContent = ''; searchMatches = []; }
        }

        function findMatches() {
            const query = searchInput.value;
            if (!query) { searchResults.textContent = ''; searchMatches = []; return; }
            const text = editor.value;
            searchMatches = [];
            let index = 0;
            while ((index = text.indexOf(query, index)) !== -1) { searchMatches.push(index); index += query.length; }
            if (searchMatches.length === 0) searchResults.textContent = 'No matches';
            else searchResults.textContent = `${searchMatches.length} match${searchMatches.length > 1 ? 'es' : ''}`;
        }

        function replaceNext() {
            const query = searchInput.value;
            const replacement = replaceInput.value;
            if (!query) return;
            const text = editor.value;
            const start = editor.selectionStart;
            const index = text.indexOf(query, start);
            if (index !== -1) {
                editor.value = text.substring(0, index) + replacement + text.substring(index + query.length);
                editor.selectionStart = index;
                editor.selectionEnd = index + replacement.length;
                editor.focus();
                debouncedSave();
                updateStats();
                findMatches();
            } else {
                const firstIndex = text.indexOf(query);
                if (firstIndex !== -1) {
                    editor.value = text.substring(0, firstIndex) + replacement + text.substring(firstIndex + query.length);
                    editor.selectionStart = firstIndex;
                    editor.selectionEnd = firstIndex + replacement.length;
                    editor.focus();
                    debouncedSave();
                    updateStats();
                    findMatches();
                }
            }
        }

        function replaceAll() {
            const query = searchInput.value;
            const replacement = replaceInput.value;
            if (!query) return;
            const count = (editor.value.match(new RegExp(escapeRegex(query), 'g')) || []).length;
            if (count === 0) { searchResults.textContent = 'No matches'; return; }
            if (confirm(`Replace ${count} occurrence${count > 1 ? 's' : ''}?`)) {
                editor.value = editor.value.split(query).join(replacement);
                debouncedSave();
                updateStats();
                findMatches();
                searchResults.textContent = `Replaced ${count} occurrence${count > 1 ? 's' : ''}`;
            }
        }

        function escapeRegex(str) { return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'); }
        function toggleHelp() { helpModal.classList.toggle('active'); }
        searchInput.addEventListener('input', findMatches);

        function wrapSelection(before, after = before) {
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const selectedText = editor.value.substring(start, end);
            const replacement = before + selectedText + after;
            editor.value = editor.value.substring(0, start) + replacement + editor.value.substring(end);
            if (selectedText) { editor.selectionStart = start + before.length; editor.selectionEnd = end + before.length; }
            else editor.selectionStart = editor.selectionEnd = start + before.length;
            editor.focus();
            debouncedSave();
            updateStats();
        }

        editor.addEventListener('input', () => { debouncedSave(); updateStats(); if (isPreviewMode) updatePreview(); });

        document.addEventListener('keydown', (e) => {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const modKey = isMac ? e.metaKey : e.ctrlKey;
            if (modKey && !e.shiftKey && e.key >= '1' && e.key <= '9') {
                const index = parseInt(e.key) - 1;
                if (index < tabs.length) { e.preventDefault(); switchTab(tabs[index].id); }
            }
            if (modKey && e.shiftKey && e.key.toLowerCase() === 'f') { e.preventDefault(); toggleSearch(); }
            if (modKey && !isPreviewMode) {
                switch(e.key.toLowerCase()) {
                    case 'b': e.preventDefault(); wrapSelection('**'); break;
                    case 'i': e.preventDefault(); wrapSelection('*'); break;
                    case 'k': e.preventDefault(); wrapSelection('[', '](url)'); break;
                    case '`': e.preventDefault(); wrapSelection('`'); break;
                    case 'e': e.preventDefault(); togglePreview(); break;
                }
            } else if (modKey && e.key.toLowerCase() === 'e') { e.preventDefault(); togglePreview(); }
            if (modKey && e.shiftKey && e.key.toLowerCase() === 'c' && !isPreviewMode) {
                e.preventDefault();
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const selectedText = editor.value.substring(start, end);
                const replacement = '```\n' + selectedText + '\n```';
                editor.value = editor.value.substring(0, start) + replacement + editor.value.substring(end);
                editor.selectionStart = start + 4;
                editor.selectionEnd = start + 4 + selectedText.length;
                editor.focus();
                debouncedSave();
                updateStats();
            }
        });

        // GITHUB SYNC FUNCTIONS
        function showSyncSetup() { syncModal.classList.add('active'); document.getElementById('githubToken').focus(); }
        function closeSyncModal() { syncModal.classList.remove('active'); }

        async function setupSync() {
            const token = document.getElementById('githubToken').value.trim();
            if (!token.startsWith('ghp_') && !token.startsWith('github_pat_')) {
                alert('Invalid token format. GitHub PATs start with "ghp_" or "github_pat_"');
                return;
            }
            localStorage.setItem('notes_github_token', token);
            syncSetupBtn.style.display = 'none';
            syncNowBtn.style.display = 'inline-block';
            closeSyncModal();
            updateSyncStatus('syncing', 'Setting up...');
            await syncToGitHub();
            startAutoSync();
        }

        function disableSync() {
            if (!confirm('Disable GitHub sync? Local data will remain but will no longer sync.')) return;
            localStorage.removeItem('notes_github_token');
            localStorage.removeItem('notes_gist_id');
            syncSetupBtn.style.display = 'inline-block';
            syncNowBtn.style.display = 'none';
            stopAutoSync();
            updateSyncStatus('', '');
            closeSyncModal();
        }

        async function syncToGitHub() {
            const token = localStorage.getItem('notes_github_token');
            if (!token) return;
            const gistId = localStorage.getItem('notes_gist_id');
            updateSyncStatus('syncing', '↻ Syncing...');
            const data = { tabs, currentTabId, lastSync: new Date().toISOString() };
            const payload = { description: 'Notes Data (Auto-synced)', public: false, files: { 'notes-data.json': { content: JSON.stringify(data, null, 2) } } };
            try {
                let response;
                if (gistId) response = await fetch(`${GITHUB_API}/gists/${gistId}`, { method: 'PATCH', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                else { response = await fetch(`${GITHUB_API}/gists`, { method: 'POST', headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (response.ok) { const gist = await response.json(); localStorage.setItem('notes_gist_id', gist.id); } }
                if (response.ok) { updateSyncStatus('synced', '☁️ Synced'); lastSyncTime = Date.now(); }
                else { console.error('Sync failed:', await response.json()); updateSyncStatus('error', '⚠️ Sync failed'); }
            } catch (err) { console.error('Sync error:', err); updateSyncStatus('error', '⚠️ Sync error'); }
        }

        async function syncFromGitHub() {
            const token = localStorage.getItem('notes_github_token');
            const gistId = localStorage.getItem('notes_gist_id');
            if (!token || !gistId) { alert('GitHub sync not configured'); return; }
            updateSyncStatus('syncing', '↻ Pulling...');
            try {
                const response = await fetch(`${GITHUB_API}/gists/${gistId}`, { headers: { 'Authorization': `token ${token}` } });
                if (response.ok) {
                    const gist = await response.json();
                    const content = gist.files['notes-data.json'].content;
                    const data = JSON.parse(content);
                    tabs = data.tabs;
                    currentTabId = data.currentTabId || tabs[0].id;
                    saveTabs();
                    renderTabs();
                    editor.value = tabs.find(t => t.id === currentTabId).content;
                    updateStats();
                    updateSyncStatus('synced', '☁️ Synced');
                    lastSyncTime = Date.now();
                } else { console.error('Pull failed:', await response.json()); updateSyncStatus('error', '⚠️ Pull failed'); }
            } catch (err) { console.error('Pull error:', err); updateSyncStatus('error', '⚠️ Pull error'); }
        }

        function syncNow() {
            if (!confirm('Pull latest data from GitHub? This will overwrite any local changes.')) return;
            syncFromGitHub();
        }

        function updateSyncStatus(state, text) {
            syncStatus.className = 'sync-status ' + state;
            syncStatus.textContent = text;
        }

        function startAutoSync() {
            stopAutoSync();
            syncInterval = setInterval(() => {
                if (Date.now() - lastSyncTime >= SYNC_INTERVAL_MS) syncToGitHub();
            }, SYNC_INTERVAL_MS);
        }

        function stopAutoSync() { if (syncInterval) { clearInterval(syncInterval); syncInterval = null; } }

        // Check if sync is configured on load
        if (localStorage.getItem('notes_github_token')) {
            syncSetupBtn.style.display = 'none';
            syncNowBtn.style.display = 'inline-block';
            updateSyncStatus('synced', '☁️ Ready');
            startAutoSync();
        }

        renderTabs();
        editor.value = tabs.find(t => t.id === currentTabId).content;
        updateStats();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Runbook Checklist</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%23458588'/><text x='50' y='50' text-anchor='middle' dy='.35em' font-size='50' fill='%23282828' font-family='Arial,sans-serif' font-weight='bold'>âœ“</text></svg>">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'JetBrains Mono', monospace;
            background: #1d2021;
            color: #ebdbb2;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .header {
            background: #282828;
            border-bottom: 2px solid #458588;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }
        .header h1 {
            color: #83a598;
            font-size: 22px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .header-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        button {
            background: #458588;
            color: #ebdbb2;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }
        button:hover {
            background: #83a598;
        }
        button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-success {
            background: #98971a;
        }
        .btn-success:hover {
            background: #b8bb26;
        }
        .btn-danger {
            background: #cc241d;
        }
        .btn-danger:hover {
            background: #fb4934;
        }
        .btn-warning {
            background: #d79921;
        }
        .btn-warning:hover {
            background: #fabd2f;
        }
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background: #282828;
            border-right: 1px solid #3c3836;
            overflow-y: auto;
            padding: 16px;
        }
        .sidebar h3 {
            color: #fabd2f;
            font-size: 14px;
            margin-bottom: 12px;
            text-transform: uppercase;
        }
        .runbook-item {
            background: #3c3836;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
            border-left: 3px solid transparent;
        }
        .runbook-item:hover {
            background: #504945;
        }
        .runbook-item.active {
            background: #504945;
            border-left-color: #458588;
        }
        .runbook-item-title {
            color: #ebdbb2;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .runbook-item-meta {
            color: #928374;
            font-size: 11px;
        }
        .runbook-item-progress {
            margin-top: 6px;
            height: 4px;
            background: #1d2021;
            border-radius: 2px;
            overflow: hidden;
        }
        .runbook-item-progress-bar {
            height: 100%;
            background: #458588;
            transition: width 0.3s;
        }
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .runbook-header {
            background: #282828;
            border-bottom: 1px solid #3c3836;
            padding: 20px;
        }
        .runbook-title {
            color: #83a598;
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .runbook-description {
            color: #928374;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 12px;
        }
        .progress-bar-container {
            margin-top: 16px;
        }
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 12px;
            color: #928374;
        }
        .progress-bar {
            height: 12px;
            background: #3c3836;
            border-radius: 6px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #458588, #83a598);
            transition: width 0.3s;
            border-radius: 6px;
        }
        .progress-bar-fill.complete {
            background: linear-gradient(90deg, #98971a, #b8bb26);
        }
        .checklist {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        .step {
            background: #282828;
            border: 1px solid #3c3836;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }
        .step.completed {
            border-color: #98971a;
            background: #2a2e23;
        }
        .step.critical {
            border-left: 4px solid #fb4934;
        }
        .step-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
        }
        .checkbox-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: #3c3836;
            border: 2px solid #504945;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .checkbox-container:hover {
            border-color: #83a598;
        }
        .checkbox-container.checked {
            background: #98971a;
            border-color: #b8bb26;
        }
        .checkbox-container.checked::after {
            content: 'âœ“';
            color: #282828;
            font-size: 16px;
            font-weight: 700;
        }
        .step-content {
            flex: 1;
        }
        .step-number {
            color: #928374;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
        }
        .step-title {
            color: #ebdbb2;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 6px;
        }
        .step-description {
            color: #a89984;
            font-size: 13px;
            line-height: 1.5;
            margin-bottom: 10px;
        }
        .step-command {
            background: #1d2021;
            border: 1px solid #3c3836;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
            color: #d8a657;
            margin-bottom: 10px;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .step-notes {
            margin-top: 12px;
        }
        .step-notes textarea {
            width: 100%;
            background: #3c3836;
            border: 1px solid #504945;
            color: #ebdbb2;
            padding: 10px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
        }
        .step-notes textarea:focus {
            outline: none;
            border-color: #458588;
        }
        .step-notes-label {
            color: #928374;
            font-size: 11px;
            margin-bottom: 6px;
            display: block;
        }
        .step-timestamp {
            color: #458588;
            font-size: 11px;
            margin-top: 8px;
            font-weight: 600;
        }
        .step-required {
            display: inline-block;
            background: #fb4934;
            color: #282828;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 700;
            margin-left: 8px;
        }
        .empty-state {
            text-align: center;
            color: #665c54;
            padding: 60px 20px;
            font-size: 14px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: #282828;
            border: 2px solid #504945;
            border-radius: 8px;
            padding: 24px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h2 {
            color: #fabd2f;
            font-size: 18px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            color: #928374;
            font-size: 13px;
            margin-bottom: 6px;
            font-weight: 600;
        }
        .form-group input,
        .form-group textarea {
            width: 100%;
            background: #3c3836;
            border: 1px solid #504945;
            color: #ebdbb2;
            padding: 10px 12px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
        }
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #458588;
        }
        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .steps-editor {
            margin-top: 16px;
        }
        .step-editor-item {
            background: #3c3836;
            border: 1px solid #504945;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 12px;
        }
        .step-editor-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 8px;
        }
        .step-editor-number {
            color: #928374;
            font-size: 12px;
            font-weight: 600;
            flex: 1;
        }
        .history-item {
            background: #3c3836;
            border: 1px solid #504945;
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 12px;
        }
        .history-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .history-item-date {
            color: #928374;
            font-weight: 600;
        }
        .history-item-duration {
            color: #83a598;
        }
        .history-item-steps {
            color: #a89984;
        }
        .stats {
            padding: 8px 20px;
            background: #282828;
            border-top: 1px solid #3c3836;
            font-size: 12px;
            color: #928374;
            display: flex;
            gap: 20px;
        }
        .shortcut-hint {
            font-size: 11px;
            color: #665c54;
            margin-top: 16px;
            padding: 12px;
            background: #282828;
            border-radius: 4px;
        }
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #1d2021;
        }
        ::-webkit-scrollbar-thumb {
            background: #504945;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #665c54;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ“‹ RUNBOOK CHECKLIST</h1>
        <div class="header-actions">
            <button onclick="showNewRunbookModal()">+ New Runbook</button>
            <button onclick="showHistoryModal()" id="historyBtn" disabled>History</button>
            <button class="btn-warning" onclick="resetCurrentRunbook()" id="resetBtn" disabled>â†» Reset</button>
            <button class="btn-success" onclick="exportMarkdown()" id="exportBtn" disabled>â†“ Export MD</button>
            <button onclick="exportJSON()">â†“ Export JSON</button>
            <button onclick="importJSON()">â†‘ Import</button>
        </div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <h3>Your Runbooks</h3>
            <div id="runbookList"></div>
        </div>

        <div class="content">
            <div id="runbookView"></div>
        </div>
    </div>

    <div class="stats">
        <span id="statsRunbooks">0 runbooks</span>
        <span id="statsExecutions">0 total executions</span>
    </div>

    <!-- New Runbook Modal -->
    <div class="modal" id="newRunbookModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Runbook</h2>
                <button onclick="closeModal('newRunbookModal')">âœ•</button>
            </div>
            <form onsubmit="createRunbook(event)">
                <div class="form-group">
                    <label>Runbook Title *</label>
                    <input type="text" id="runbookTitle" required placeholder="e.g., Deploy Payment API">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="runbookDescription" placeholder="What does this runbook do?"></textarea>
                </div>
                <div class="form-group">
                    <label>Steps (one per line) *</label>
                    <textarea id="runbookSteps" required placeholder="Check current version&#10;Create backup&#10;Deploy new version&#10;Verify health checks&#10;Monitor for 5 minutes" style="min-height: 200px;"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" onclick="closeModal('newRunbookModal')">Cancel</button>
                    <button type="submit" class="btn-success">Create Runbook</button>
                </div>
            </form>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Execution History</h2>
                <button onclick="closeModal('historyModal')">âœ•</button>
            </div>
            <div id="historyContent"></div>
            <div class="form-actions">
                <button onclick="closeModal('historyModal')">Close</button>
            </div>
        </div>
    </div>

    <input type="file" id="importInput" style="display: none;" accept=".json" onchange="handleImport(event)">

    <script>
        let runbooks = JSON.parse(localStorage.getItem('runbooks')) || getDefaultRunbooks();
        let currentRunbookId = localStorage.getItem('currentRunbookId') || null;
        let executions = JSON.parse(localStorage.getItem('executions')) || {};

        function getDefaultRunbooks() {
            return [
                {
                    id: '1',
                    title: 'Kubernetes Pod Restart',
                    description: 'Standard procedure for restarting pods when they are crashlooping or unhealthy',
                    steps: [
                        { id: '1', title: 'Identify failing pod', description: 'Get pod name and namespace', command: 'kubectl get pods -n {{namespace}} | grep -v Running', required: false },
                        { id: '2', title: 'Check pod logs', description: 'Review recent logs for errors', command: 'kubectl logs {{pod-name}} -n {{namespace}} --tail=100', required: true },
                        { id: '3', title: 'Describe pod', description: 'Check events and resource status', command: 'kubectl describe pod {{pod-name}} -n {{namespace}}', required: true },
                        { id: '4', title: 'Check resource usage', description: 'Verify CPU/memory limits', command: 'kubectl top pod {{pod-name}} -n {{namespace}}', required: false },
                        { id: '5', title: 'Delete pod', description: 'Force restart by deleting pod (deployment will recreate)', command: 'kubectl delete pod {{pod-name}} -n {{namespace}}', required: true },
                        { id: '6', title: 'Verify new pod', description: 'Confirm new pod is running', command: 'kubectl get pods -n {{namespace}} -w', required: true },
                        { id: '7', title: 'Check health', description: 'Verify readiness and liveness probes pass', command: 'kubectl get pods {{pod-name}} -n {{namespace}} -o jsonpath=\'{.status.conditions}\'', required: true }
                    ],
                    created: new Date().toISOString()
                },
                {
                    id: '2',
                    title: 'Database Failover',
                    description: 'Emergency procedure for failing over to standby database',
                    steps: [
                        { id: '1', title: 'Confirm primary failure', description: 'Verify primary DB is unresponsive', command: 'pg_isready -h {{primary-host}} -p 5432', required: true },
                        { id: '2', title: 'Check replication lag', description: 'Ensure standby is up to date', command: 'psql -h {{standby-host}} -c "SELECT pg_last_wal_receive_lsn();"', required: true },
                        { id: '3', title: 'Stop application writes', description: 'Put app in read-only mode or take offline', command: '', required: true },
                        { id: '4', title: 'Promote standby', description: 'Promote standby to primary', command: 'pg_ctl promote -D /var/lib/postgresql/data', required: true },
                        { id: '5', title: 'Verify promotion', description: 'Confirm standby is now primary', command: 'psql -h {{standby-host}} -c "SELECT pg_is_in_recovery();"', required: true },
                        { id: '6', title: 'Update DNS/connection strings', description: 'Point applications to new primary', command: '', required: true },
                        { id: '7', title: 'Resume application', description: 'Bring application back online', command: '', required: true },
                        { id: '8', title: 'Monitor performance', description: 'Watch for replication issues', command: '', required: true }
                    ],
                    created: new Date().toISOString()
                },
                {
                    id: '3',
                    title: 'Application Rollback',
                    description: 'Roll back application to previous version after failed deployment',
                    steps: [
                        { id: '1', title: 'Identify issue', description: 'Confirm current version has critical bug', command: '', required: true },
                        { id: '2', title: 'Check rollback history', description: 'Find previous stable version', command: 'kubectl rollout history deployment {{deployment}} -n {{namespace}}', required: true },
                        { id: '3', title: 'Initiate rollback', description: 'Roll back to previous revision', command: 'kubectl rollout undo deployment {{deployment}} -n {{namespace}}', required: true },
                        { id: '4', title: 'Watch rollout', description: 'Monitor rollback progress', command: 'kubectl rollout status deployment {{deployment}} -n {{namespace}}', required: true },
                        { id: '5', title: 'Verify pods', description: 'Confirm old version is running', command: 'kubectl get pods -n {{namespace}} -l app={{app}} -o jsonpath=\'{.items[*].spec.containers[*].image}\'', required: true },
                        { id: '6', title: 'Test functionality', description: 'Run smoke tests or manual verification', command: '', required: true },
                        { id: '7', title: 'Monitor metrics', description: 'Watch error rates and performance', command: '', required: true },
                        { id: '8', title: 'Notify stakeholders', description: 'Update team on rollback completion', command: '', required: false }
                    ],
                    created: new Date().toISOString()
                },
                {
                    id: '4',
                    title: 'Security Incident Response',
                    description: 'Initial response steps for security incidents',
                    steps: [
                        { id: '1', title: 'Document incident', description: 'Record time, nature, and scope of incident', command: '', required: true },
                        { id: '2', title: 'Notify security team', description: 'Alert security team immediately', command: '', required: true },
                        { id: '3', title: 'Contain threat', description: 'Isolate affected systems (network isolation, disable accounts)', command: '', required: true },
                        { id: '4', title: 'Preserve evidence', description: 'Take snapshots, capture logs, document state', command: '', required: true },
                        { id: '5', title: 'Assess impact', description: 'Determine what data/systems were compromised', command: '', required: true },
                        { id: '6', title: 'Reset credentials', description: 'Rotate all potentially compromised credentials', command: '', required: true },
                        { id: '7', title: 'Patch vulnerabilities', description: 'Apply security patches immediately', command: '', required: true },
                        { id: '8', title: 'Monitor for reinfection', description: 'Watch for signs of persistent threat', command: '', required: true },
                        { id: '9', title: 'Notify stakeholders', description: 'Inform management and affected parties', command: '', required: true },
                        { id: '10', title: 'Document lessons learned', description: 'Write post-mortem', command: '', required: true }
                    ],
                    created: new Date().toISOString()
                },
                {
                    id: '5',
                    title: 'Load Balancer Maintenance',
                    description: 'Taking a load balancer out of rotation for maintenance',
                    steps: [
                        { id: '1', title: 'Check current traffic', description: 'Verify load distribution', command: '', required: false },
                        { id: '2', title: 'Notify team', description: 'Alert team of maintenance window', command: '', required: true },
                        { id: '3', title: 'Drain connections', description: 'Stop sending new traffic to LB', command: '', required: true },
                        { id: '4', title: 'Wait for active connections', description: 'Allow existing connections to complete (wait 5 min)', command: '', required: true },
                        { id: '5', title: 'Perform maintenance', description: 'Execute required updates or changes', command: '', required: true },
                        { id: '6', title: 'Test LB', description: 'Verify LB responds correctly', command: '', required: true },
                        { id: '7', title: 'Restore traffic', description: 'Add LB back to rotation', command: '', required: true },
                        { id: '8', title: 'Monitor traffic distribution', description: 'Confirm even distribution across all LBs', command: '', required: true }
                    ],
                    created: new Date().toISOString()
                }
            ];
        }

        function getCurrentRunbook() {
            return runbooks.find(r => r.id === currentRunbookId);
        }

        function getCurrentExecution() {
            if (!currentRunbookId || !executions[currentRunbookId]) return null;
            const execs = executions[currentRunbookId];
            return execs[execs.length - 1];
        }

        function saveData() {
            localStorage.setItem('runbooks', JSON.stringify(runbooks));
            localStorage.setItem('currentRunbookId', currentRunbookId);
            localStorage.setItem('executions', JSON.stringify(executions));
        }

        function formatTimestamp(date) {
            return new Date(date).toISOString().replace('T', ' ').substr(0, 19) + ' UTC';
        }

        function renderRunbookList() {
            const list = document.getElementById('runbookList');
            
            if (runbooks.length === 0) {
                list.innerHTML = '<div style="color: #665c54; font-size: 12px; text-align: center; padding: 20px;">No runbooks yet</div>';
                return;
            }

            let html = '';
            runbooks.forEach(runbook => {
                const isActive = runbook.id === currentRunbookId;
                const execution = getCurrentExecution();
                const progress = execution ? calculateProgress(runbook, execution) : 0;
                
                html += `
                    <div class="runbook-item ${isActive ? 'active' : ''}" onclick="selectRunbook('${runbook.id}')">
                        <div class="runbook-item-title">${escapeHtml(runbook.title)}</div>
                        <div class="runbook-item-meta">${runbook.steps.length} steps</div>
                        ${isActive && execution ? `
                        <div class="runbook-item-progress">
                            <div class="runbook-item-progress-bar" style="width: ${progress}%"></div>
                        </div>
                        ` : ''}
                    </div>
                `;
            });

            list.innerHTML = html;
        }

        function calculateProgress(runbook, execution) {
            if (!execution || !execution.steps) return 0;
            const completed = Object.values(execution.steps).filter(s => s.completed).length;
            return Math.round((completed / runbook.steps.length) * 100);
        }

        function selectRunbook(runbookId) {
            currentRunbookId = runbookId;
            
            // Create new execution if none exists or if previous is complete
            if (!executions[runbookId]) {
                executions[runbookId] = [];
            }
            
            const lastExec = executions[runbookId][executions[runbookId].length - 1];
            if (!lastExec || lastExec.completed) {
                startNewExecution(runbookId);
            }
            
            saveData();
            renderAll();
        }

        function startNewExecution(runbookId) {
            if (!executions[runbookId]) {
                executions[runbookId] = [];
            }
            
            executions[runbookId].push({
                id: Date.now().toString(),
                startTime: new Date().toISOString(),
                endTime: null,
                completed: false,
                steps: {}
            });
            
            saveData();
        }

        function renderRunbookView() {
            const view = document.getElementById('runbookView');
            const runbook = getCurrentRunbook();

            if (!runbook) {
                view.innerHTML = `
                    <div class="empty-state">
                        Select a runbook to begin<br><br>
                        <button onclick="showNewRunbookModal()">+ Create First Runbook</button>
                    </div>
                `;
                document.getElementById('resetBtn').disabled = true;
                document.getElementById('exportBtn').disabled = true;
                document.getElementById('historyBtn').disabled = true;
                return;
            }

            const execution = getCurrentExecution();
            const progress = execution ? calculateProgress(runbook, execution) : 0;
            const completedSteps = execution ? Object.values(execution.steps).filter(s => s.completed).length : 0;

            document.getElementById('resetBtn').disabled = false;
            document.getElementById('exportBtn').disabled = false;
            document.getElementById('historyBtn').disabled = false;

            let html = `
                <div class="runbook-header">
                    <div class="runbook-title">${escapeHtml(runbook.title)}</div>
                    <div class="runbook-description">${escapeHtml(runbook.description || '')}</div>
                    <div class="progress-bar-container">
                        <div class="progress-label">
                            <span>Progress</span>
                            <span>${completedSteps} / ${runbook.steps.length} steps (${progress}%)</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill ${progress === 100 ? 'complete' : ''}" style="width: ${progress}%"></div>
                        </div>
                    </div>
                </div>
                <div class="checklist">
            `;

            runbook.steps.forEach((step, index) => {
                const stepExec = execution?.steps[step.id] || {};
                const isCompleted = stepExec.completed || false;
                const notes = stepExec.notes || '';
                const timestamp = stepExec.timestamp;

                html += `
                    <div class="step ${isCompleted ? 'completed' : ''} ${step.required ? 'critical' : ''}">
                        <div class="step-header">
                            <div class="checkbox-container ${isCompleted ? 'checked' : ''}" onclick="toggleStep('${step.id}')"></div>
                            <div class="step-content">
                                <div class="step-number">STEP ${index + 1}${step.required ? '<span class="step-required">REQUIRED</span>' : ''}</div>
                                <div class="step-title">${escapeHtml(step.title)}</div>
                                ${step.description ? `<div class="step-description">${escapeHtml(step.description)}</div>` : ''}
                                ${step.command ? `<div class="step-command">${escapeHtml(step.command)}</div>` : ''}
                                <div class="step-notes">
                                    <label class="step-notes-label">Notes (what did you find?)</label>
                                    <textarea 
                                        onchange="updateStepNotes('${step.id}', this.value)"
                                        placeholder="Add notes about this step..."
                                    >${escapeHtml(notes)}</textarea>
                                </div>
                                ${timestamp ? `<div class="step-timestamp">âœ“ Completed: ${formatTimestamp(timestamp)}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });

            html += `
                    <div class="shortcut-hint">
                        ðŸ’¡ Shortcuts: Space = Toggle current step | N = Next step | R = Reset runbook | E = Export | Escape = Clear selection
                    </div>
                </div>
            `;

            view.innerHTML = html;
        }

        function toggleStep(stepId) {
            const execution = getCurrentExecution();
            if (!execution) return;

            if (!execution.steps[stepId]) {
                execution.steps[stepId] = {};
            }

            execution.steps[stepId].completed = !execution.steps[stepId].completed;
            
            if (execution.steps[stepId].completed) {
                execution.steps[stepId].timestamp = new Date().toISOString();
            } else {
                delete execution.steps[stepId].timestamp;
            }

            saveData();
            renderAll();
        }

        function updateStepNotes(stepId, notes) {
            const execution = getCurrentExecution();
            if (!execution) return;

            if (!execution.steps[stepId]) {
                execution.steps[stepId] = {};
            }

            execution.steps[stepId].notes = notes;
            saveData();
        }

        function resetCurrentRunbook() {
            if (!confirm('Reset this runbook? All checkboxes and notes will be cleared and a new execution will start.')) {
                return;
            }

            const execution = getCurrentExecution();
            if (execution) {
                execution.endTime = new Date().toISOString();
                execution.completed = true;
            }

            startNewExecution(currentRunbookId);
            renderAll();
        }

        function showNewRunbookModal() {
            document.getElementById('newRunbookModal').classList.add('active');
            document.getElementById('runbookTitle').focus();
        }

        function createRunbook(event) {
            event.preventDefault();

            const title = document.getElementById('runbookTitle').value.trim();
            const description = document.getElementById('runbookDescription').value.trim();
            const stepsText = document.getElementById('runbookSteps').value.trim();

            const stepLines = stepsText.split('\n').filter(l => l.trim());
            const steps = stepLines.map((line, index) => ({
                id: (index + 1).toString(),
                title: line.trim(),
                description: '',
                command: '',
                required: false
            }));

            const runbook = {
                id: Date.now().toString(),
                title,
                description,
                steps,
                created: new Date().toISOString()
            };

            runbooks.unshift(runbook);
            currentRunbookId = runbook.id;
            startNewExecution(runbook.id);
            saveData();
            
            closeModal('newRunbookModal');
            document.getElementById('runbookTitle').value = '';
            document.getElementById('runbookDescription').value = '';
            document.getElementById('runbookSteps').value = '';
            
            renderAll();
        }

        function showHistoryModal() {
            const runbook = getCurrentRunbook();
            if (!runbook) return;

            const execs = executions[runbook.id] || [];
            const content = document.getElementById('historyContent');

            if (execs.length === 0) {
                content.innerHTML = '<div style="color: #665c54; padding: 20px; text-align: center;">No execution history yet</div>';
            } else {
                let html = '';
                execs.slice().reverse().forEach((exec, index) => {
                    const completed = Object.values(exec.steps).filter(s => s.completed).length;
                    const duration = exec.endTime 
                        ? Math.round((new Date(exec.endTime) - new Date(exec.startTime)) / 60000) 
                        : Math.round((new Date() - new Date(exec.startTime)) / 60000);
                    
                    html += `
                        <div class="history-item">
                            <div class="history-item-header">
                                <span class="history-item-date">${formatTimestamp(exec.startTime)}</span>
                                <span class="history-item-duration">${duration} min</span>
                            </div>
                            <div class="history-item-steps">Completed: ${completed} / ${runbook.steps.length} steps</div>
                        </div>
                    `;
                });
                content.innerHTML = html;
            }

            document.getElementById('historyModal').classList.add('active');
        }

        function exportMarkdown() {
            const runbook = getCurrentRunbook();
            const execution = getCurrentExecution();
            if (!runbook || !execution) return;

            let md = `# Runbook Execution: ${runbook.title}\n\n`;
            md += `**Description:** ${runbook.description}\n`;
            md += `**Started:** ${formatTimestamp(execution.startTime)}\n`;
            if (execution.endTime) {
                md += `**Completed:** ${formatTimestamp(execution.endTime)}\n`;
            }
            md += `\n---\n\n`;

            md += `## Steps\n\n`;

            runbook.steps.forEach((step, index) => {
                const stepExec = execution.steps[step.id] || {};
                const status = stepExec.completed ? 'âœ…' : 'â¬œ';
                
                md += `### ${status} Step ${index + 1}: ${step.title}\n\n`;
                if (step.description) {
                    md += `**Description:** ${step.description}\n\n`;
                }
                if (step.command) {
                    md += `**Command:**\n\`\`\`\n${step.command}\n\`\`\`\n\n`;
                }
                if (stepExec.notes) {
                    md += `**Notes:**\n${stepExec.notes}\n\n`;
                }
                if (stepExec.timestamp) {
                    md += `**Completed:** ${formatTimestamp(stepExec.timestamp)}\n\n`;
                }
                md += `---\n\n`;
            });

            const blob = new Blob([md], { type: 'text/markdown' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `runbook-${runbook.id}-${execution.startTime.split('T')[0]}.md`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportJSON() {
            const data = JSON.stringify({ runbooks, executions }, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `runbooks-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importJSON() {
            document.getElementById('importInput').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const imported = JSON.parse(e.target.result);
                    
                    if (imported.runbooks && Array.isArray(imported.runbooks)) {
                        if (confirm(`Import ${imported.runbooks.length} runbooks? This will replace all current data.`)) {
                            runbooks = imported.runbooks;
                            executions = imported.executions || {};
                            currentRunbookId = runbooks.length > 0 ? runbooks[0].id : null;
                            saveData();
                            renderAll();
                        }
                    } else {
                        alert('Invalid file format');
                    }
                } catch (err) {
                    alert('Failed to parse JSON file');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function updateStats() {
            const totalExecs = Object.values(executions).reduce((sum, execs) => sum + execs.length, 0);
            document.getElementById('statsRunbooks').textContent = `${runbooks.length} runbooks`;
            document.getElementById('statsExecutions').textContent = `${totalExecs} total executions`;
        }

        function renderAll() {
            renderRunbookList();
            renderRunbookView();
            updateStats();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
            const modKey = isMac ? e.metaKey : e.ctrlKey;

            if (modKey && e.key === 'n') {
                e.preventDefault();
                showNewRunbookModal();
            }

            if (modKey && e.key === 'r') {
                e.preventDefault();
                resetCurrentRunbook();
            }

            if (modKey && e.key === 'e') {
                e.preventDefault();
                exportMarkdown();
            }

            if (e.key === 'Escape') {
                closeModal('newRunbookModal');
                closeModal('historyModal');
            }
        });

        // Initial render
        renderAll();

        // Show modal if no runbooks (but we have defaults, so this won't trigger)
        if (runbooks.length === 0) {
            setTimeout(() => showNewRunbookModal(), 500);
        }
    </script>
</body>
</html>
